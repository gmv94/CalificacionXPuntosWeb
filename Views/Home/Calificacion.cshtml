@{
    ViewData["Title"] = "Calificación de la Idea";
    var modo = ViewBag.Modo as string ?? "";
    var idea = ViewBag.Idea as CalificacionXPuntosWeb.Models.Idea;
    var categorias = ViewBag.Categorias as List<string> ?? new List<string>();
    var estados = ViewBag.Estados as List<string> ?? new List<string>();
    var procesos = ViewBag.Procesos as List<string> ?? new List<string>();
    var esModoVer = modo == "ver";
    var esModoEditar = modo == "editar";
}

<h3>Calificación de la Idea</h3>

@if (modo == "ver")
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Modo de visualización - Solo lectura
    </div>
}
else if (modo == "editar")
{
    <div class="alert alert-warning">
        <i class="bi bi-pencil"></i> Modo de edición
    </div>
}

<div class="card">
    <div class="card-header">
        <h4 style="font-size: calc(1.25rem);">@(modo == "ver" ? "Ver Registro" : modo == "editar" ? "Editar Registro" : "Nuevo Registro")</h4>
    </div>
    <div class="card-body">
        <form method="post" action="/Home/GuardarCalificacion?modo=@modo" id="formCalificacion" novalidate>
            <input type="hidden" name="Id" value="@(idea?.Id ?? 0)" />
            @{
                var fechaRegistroValue = idea != null && idea.FechaRegistro != default(DateTime) 
                    ? idea.FechaRegistro.ToString("yyyy-MM-ddTHH:mm:ss") 
                    : DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss");
            }
            <input type="hidden" name="FechaRegistro" value="@fechaRegistroValue" />
            <input type="hidden" name="ImpactosJson" id="impactosJson" value="@(idea?.ImpactosJson ?? "{}")" />
            
            <!-- Información Básica -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="numeroDocumento" class="form-label">Documento: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="numeroDocumento" name="NumeroDocumento" value="@idea?.NumeroDocumento" maxlength="50" @(esModoVer ? "readonly" : "required") />
                        </div>
                        <div class="col-md-6">
                            <label for="nombreUsuario" class="form-label">Nombre: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombreUsuario" name="NombreUsuario" value="@idea?.NombreUsuario" maxlength="200" @(esModoVer ? "readonly" : "required") />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="celular" class="form-label">Celular:</label>
                            <input type="text" class="form-control" id="celular" name="Celular" value="@idea?.Celular" placeholder="Ej: 3001234567" maxlength="20" @(esModoVer ? "readonly" : "") />
                        </div>
                        <div class="col-md-6">
                            <label for="proceso" class="form-label">Proceso:</label>
                            <select class="form-select" id="proceso" name="Proceso" @(esModoVer ? "disabled" : "")>
                                <option value="">Seleccione...</option>
                                <option value="N/A">N/A</option>
                                @foreach (var proc in procesos)
                                {
                                    @if (idea?.Proceso == proc)
                                    {
                                        <option value="@proc" selected>@proc</option>
                                    }
                                    else
                                    {
                                        <option value="@proc">@proc</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="categoria" class="form-label">Categoría:</label>
                            <select class="form-select" id="categoria" name="Categoria" @(esModoVer ? "disabled" : "") onchange="onCategoriaChanged()">
                                <option value="">Seleccione...</option>
                                @foreach (var cat in categorias)
                                {
                                    @if (idea?.Categoria == cat)
                                    {
                                        <option value="@cat" selected>@cat</option>
                                    }
                                    else
                                    {
                                        <option value="@cat">@cat</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="estado" class="form-label">Estado: <span class="text-danger">*</span></label>
                            <select class="form-select" id="estado" name="Estado" @(esModoVer ? "disabled" : "required")>
                                <option value="">Seleccione...</option>
                                @foreach (var est in estados)
                                {
                                    @if (idea?.Estado == est)
                                    {
                                        <option value="@est" selected>@est</option>
                                    }
                                    else
                                    {
                                        <option value="@est">@est</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="radicado" class="form-label">Radicado: <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="radicado" name="Radicado" value="@idea?.Radicado" maxlength="50" @(esModoVer ? "readonly" : "required") />
                        </div>
                        <div class="col-md-6">
                            <label for="fechaRadicado" class="form-label">Fecha Radicado: <span class="text-danger">*</span></label>
                            @{
                                var fechaRadicadoValue = "";
                                if (idea != null && idea.FechaRadicado != default(DateTime))
                                {
                                    fechaRadicadoValue = idea.FechaRadicado.ToString("yyyy-MM-dd");
                                }
                            }
                            <input type="date" class="form-control" id="fechaRadicado" name="FechaRadicado" value="@fechaRadicadoValue" @(esModoVer ? "readonly" : "required") />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="descripcionIdea" class="form-label">Resumen de la idea: <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="descripcionIdea" name="DescripcionIdea" rows="4" maxlength="4000" @(esModoVer ? "readonly" : "required")>@idea?.DescripcionIdea</textarea>
                            <small class="text-muted"><span id="contadorDescripcion">@(idea?.DescripcionIdea?.Length ?? 0)</span> / 4000 caracteres</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calificación de la Idea -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Calificación de la Idea</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="valorInversion" class="form-label">Valor Inversión:</label>
                            <input type="text" class="form-control" id="valorInversion" value="@(idea?.ValorInversion?.ToString("N0") ?? "")" @(esModoVer ? "readonly" : "") oninput="onValorInversionInput()" />
                            <input type="hidden" id="valorInversionHidden" name="ValorInversion" value="@(idea?.ValorInversion ?? 0)" />
                        </div>
                        <div class="col-md-6">
                            <label for="facilidadImplem" class="form-label">Facilidad Implem.:</label>
                            <select class="form-select" id="facilidadImplem" name="FacilidadImplem" @(esModoVer ? "disabled" : "") onchange="recalcularPuntos()">
                                <option value="">Seleccione...</option>
                                @if (idea?.FacilidadImplem == "A")
                                {
                                    <option value="A" selected>A</option>
                                }
                                else
                                {
                                    <option value="A">A</option>
                                }
                                @if (idea?.FacilidadImplem == "B")
                                {
                                    <option value="B" selected>B</option>
                                }
                                else
                                {
                                    <option value="B">B</option>
                                }
                                @if (idea?.FacilidadImplem == "C")
                                {
                                    <option value="C" selected>C</option>
                                }
                                else
                                {
                                    <option value="C">C</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="roiMeses" class="form-label">ROI (MESES):</label>
                            <select class="form-select" id="roiMeses" name="RoiMeses" @(esModoVer ? "disabled" : "") onchange="recalcularPuntos()">
                                <option value="">Seleccione...</option>
                                @if (idea?.RoiMeses == "<=3")
                                {
                                    <option value="<=3" selected>&lt;=3</option>
                                }
                                else
                                {
                                    <option value="<=3">&lt;=3</option>
                                }
                                @if (idea?.RoiMeses == ">3<=6")
                                {
                                    <option value=">3<=6" selected>&gt;3&lt;=6</option>
                                }
                                else
                                {
                                    <option value=">3<=6">&gt;3&lt;=6</option>
                                }
                                @if (idea?.RoiMeses == ">6")
                                {
                                    <option value=">6" selected>&gt;6</option>
                                }
                                else
                                {
                                    <option value=">6">&gt;6</option>
                                }
                                @if (idea?.RoiMeses == "N/A")
                                {
                                    <option value="N/A" selected>N/A</option>
                                }
                                else
                                {
                                    <option value="N/A">N/A</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impactos -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Porcentajes de Impacto</h5>
                </div>
                <div class="card-body" id="impactosContainer">
                    <div class="alert alert-info">Seleccione una categoría para ver los campos de impacto.</div>
                </div>
            </div>

            <!-- Puntos Extra -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Puntos Extra</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="puntosExtra" class="form-label">Puntos Extra:</label>
                            <input type="number" class="form-control" id="puntosExtra" name="PuntosExtra" value="@(idea?.PuntosExtra?.ToString() ?? "")" min="0" @(esModoVer ? "readonly" : "") onchange="recalcularPuntos()" />
                        </div>
                        <div class="col-md-6">
                            <label for="comentariosPuntosExtra" class="form-label">Comentarios Puntos Extra:</label>
                            <textarea class="form-control" id="comentariosPuntosExtra" name="ComentariosPuntosExtra" rows="3" maxlength="4000" @(esModoVer ? "readonly" : "")>@idea?.ComentariosPuntosExtra</textarea>
                            <small class="text-muted"><span id="contadorComentarios">@(idea?.ComentariosPuntosExtra?.Length ?? 0)</span> / 4000 caracteres</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observaciones -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Observaciones</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="observaciones" class="form-label">Observaciones:</label>
                            <textarea class="form-control" id="observaciones" name="Observaciones" rows="3" maxlength="4000" @(esModoVer ? "readonly" : "")>@idea?.Observaciones</textarea>
                            <small class="text-muted"><span id="contadorObservaciones">@(idea?.Observaciones?.Length ?? 0)</span> / 4000 caracteres</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen de Puntos -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Puntos Calculados</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Valor Inversión:</strong> <span id="puntosValorInversion">@((int)Math.Round(idea?.PuntosValorInversion ?? 0))</span>
                        </div>
                        <div class="col-md-3">
                            <strong>ROI:</strong> <span id="puntosROI">@((int)Math.Round(idea?.PuntosROI ?? 0))</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Facilidad Implem.:</strong> <span id="puntosFacilidadImplem">@((int)Math.Round(idea?.PuntosFacilidadImplem ?? 0))</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Impacto:</strong> <span id="puntosImpacto">@((int)Math.Round(idea?.PuntosImpacto ?? 0))</span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <strong>Puntos Extra:</strong> <span id="puntosExtraDisplay">@((int)Math.Round(idea?.PuntosExtra ?? 0))</span>
                        </div>
                        <div class="col-md-9">
                            <h4><strong>Total: <span id="puntosTotales">@((int)Math.Round(idea?.PuntosTotales ?? 0))</span> puntos</strong></h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="mb-3">
                @if (!esModoVer)
                {
                    <button type="submit" class="btn btn-primary">@(esModoEditar ? "Actualizar" : "Guardar")</button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
                }
                @if (esModoVer || esModoEditar)
                {
                    <a href="/Home/ListadoCalificaciones" class="btn btn-secondary">Volver al Listado</a>
                }
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let impactosConfig = [];
        @{
            var impactosJsonValue = "{}";
            if (idea != null && !string.IsNullOrEmpty(idea.ImpactosJson))
            {
                impactosJsonValue = idea.ImpactosJson;
            }
        }
        let impactosActuales = @Html.Raw(impactosJsonValue);
        const esModoVer = @(esModoVer ? "true" : "false");

        // Cargar impactos cuando se selecciona una categoría
        async function onCategoriaChanged() {
            const categoria = document.getElementById('categoria').value;
            if (!categoria) {
                document.getElementById('impactosContainer').innerHTML = '<div class="alert alert-info">Seleccione una categoría para ver los campos de impacto.</div>';
                return;
            }

            try {
                const response = await fetch(`/Home/GetCategoriaImpactos?nombre=${encodeURIComponent(categoria)}`);
                const data = await response.json();
                
                if (data.impactos && data.impactos.length > 0) {
                    impactosConfig = data.impactos;
                    renderizarImpactos();
                } else {
                    document.getElementById('impactosContainer').innerHTML = '<div class="alert alert-info">Esta categoría no tiene impactos configurados.</div>';
                }
            } catch (error) {
                console.error('Error al cargar impactos:', error);
            }
        }

        function renderizarImpactos() {
            const container = document.getElementById('impactosContainer');
            let html = '<div class="row">';
            
            impactosConfig.forEach(impacto => {
                const valor = impactosActuales[impacto.nombre] || 0;
                const errorClass = valor > impacto.porcentajeMaximo ? 'border-danger' : '';
                html += `
                    <div class="col-md-4 mb-2">
                        <label class="form-label">${impacto.nombre} (${impacto.porcentajeMaximo}%):</label>
                        <input type="number" 
                               class="form-control ${errorClass}" 
                               id="impacto_${impacto.nombre}"
                               value="${valor}"
                               min="0" 
                               max="${impacto.porcentajeMaximo}" 
                               step="0.01"
                               ${esModoVer ? 'readonly' : ''}
                               ${esModoVer ? '' : `onchange="onImpactoValueChanged('${impacto.nombre}', ${impacto.porcentajeMaximo})"`} />
                        ${valor > impacto.porcentajeMaximo ? `<div class="text-danger small">⚠ El valor no puede exceder ${impacto.porcentajeMaximo}%</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            recalcularPuntos();
        }

        function onImpactoValueChanged(nombre, porcentajeMaximo) {
            const input = document.getElementById(`impacto_${nombre}`);
            let valor = parseFloat(input.value) || 0;
            
            if (valor > porcentajeMaximo) {
                valor = porcentajeMaximo;
                input.value = valor;
                input.classList.add('border-danger');
            } else if (valor < 0) {
                valor = 0;
                input.value = valor;
            } else {
                input.classList.remove('border-danger');
            }
            
            impactosActuales[nombre] = valor;
            document.getElementById('impactosJson').value = JSON.stringify(impactosActuales);
            recalcularPuntos();
        }

        function onValorInversionInput() {
            const input = document.getElementById('valorInversion');
            const hidden = document.getElementById('valorInversionHidden');
            let valor = input.value.replace(/[^0-9]/g, '');
            
            if (valor) {
                const numValor = parseFloat(valor);
                hidden.value = numValor;
                input.value = numValor.toLocaleString('es-CO');
            } else {
                hidden.value = 0;
                input.value = '';
            }
            
            recalcularPuntos();
        }

        async function recalcularPuntos() {
            const valorInversion = parseFloat(document.getElementById('valorInversionHidden')?.value || 0);
            const roiMeses = document.getElementById('roiMeses')?.value || '';
            const facilidadImplem = document.getElementById('facilidadImplem')?.value || '';
            const puntosExtra = parseFloat(document.getElementById('puntosExtra')?.value || 0);
            
            try {
                const response = await fetch('/Home/CalcularPuntos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        valorInversion: valorInversion,
                        roiMeses: roiMeses,
                        facilidadImplem: facilidadImplem,
                        puntosExtra: puntosExtra,
                        impactos: impactosActuales,
                        impactosConfig: impactosConfig
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error al calcular puntos:', data.error);
                    return;
                }
                
                document.getElementById('puntosValorInversion').textContent = Math.round(data.puntosValorInversion || 0);
                document.getElementById('puntosROI').textContent = Math.round(data.puntosROI || 0);
                document.getElementById('puntosFacilidadImplem').textContent = Math.round(data.puntosFacilidadImplem || 0);
                document.getElementById('puntosImpacto').textContent = Math.round(data.puntosImpacto || 0);
                document.getElementById('puntosExtraDisplay').textContent = Math.round(puntosExtra);
                document.getElementById('puntosTotales').textContent = Math.round(data.puntosTotales || 0);
            } catch (error) {
                console.error('Error al recalcular puntos:', error);
            }
        }

        function limpiarFormulario() {
            document.getElementById('formCalificacion').reset();
            impactosActuales = {};
            document.getElementById('impactosJson').value = '{}';
            document.getElementById('impactosContainer').innerHTML = '<div class="alert alert-info">Seleccione una categoría para ver los campos de impacto.</div>';
            recalcularPuntos();
        }

        // Contador de caracteres
        document.getElementById('descripcionIdea')?.addEventListener('input', function() {
            document.getElementById('contadorDescripcion').textContent = this.value.length;
        });
        document.getElementById('comentariosPuntosExtra')?.addEventListener('input', function() {
            document.getElementById('contadorComentarios').textContent = this.value.length;
        });
        document.getElementById('observaciones')?.addEventListener('input', function() {
            document.getElementById('contadorObservaciones').textContent = this.value.length;
        });

        // Cargar impactos si ya hay una categoría seleccionada
        @if (!string.IsNullOrEmpty(idea?.Categoria))
        {
            <text>
            window.addEventListener('DOMContentLoaded', function() {
                onCategoriaChanged();
            });
            </text>
        }

        // Calcular puntos iniciales
        window.addEventListener('DOMContentLoaded', function() {
            recalcularPuntos();
        });
    </script>
}
