@{
    ViewData["Title"] = "Tabla de Premios";
    var premios = ViewBag.Premios as List<CalificacionXPuntosWeb.Models.Premio>;
    var premioActual = ViewBag.PremioActual as CalificacionXPuntosWeb.Models.Premio ?? new CalificacionXPuntosWeb.Models.Premio { Id = 0, Activo = true };
    var mostrarModal = ViewBag.MostrarModal as bool? ?? false;
}

<h3>Tabla de Premios</h3>

@if (ViewBag.EsSuperAdmin == true)
{
    <div class="mb-3">
        <a href="/Home/TablaPremios?id=0" class="btn btn-primary">Nuevo Premio</a>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Costo</th>
                <th>Puntos Requeridos</th>
                <th>Stock</th>
                <th>Activo</th>
                <th>Fecha Creación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var premio in premios ?? new List<CalificacionXPuntosWeb.Models.Premio>())
            {
                <tr>
                    <td>@premio.Id</td>
                    <td>@premio.Nombre</td>
                    <td>@premio.Descripcion</td>
                    <td>$@premio.Costo.ToString("N0")</td>
                    <td>@premio.PuntosRequeridos</td>
                    <td>@premio.Stock</td>
                    <td>
                        @if (premio.Activo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td>@premio.FechaCreacion.ToString("dd/MM/yyyy")</td>
                    <td>
                        @if (ViewBag.EsSuperAdmin == true)
                        {
                            <a href="/Home/TablaPremios?id=@premio.Id" class="btn btn-sm btn-warning">Editar</a>
                            <form method="post" action="/Home/EliminarPremio" style="display:inline;" class="form-eliminar-premio" data-id="@premio.Id" data-nombre="@premio.Nombre">
                                <input type="hidden" name="id" value="@premio.Id" />
                                <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                            </form>
                        }
                        else
                        {
                            <span class="text-muted">Solo consulta</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (mostrarModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(premioActual.Id == 0 ? "Nuevo Premio" : "Editar Premio")</h5>
                    <a href="/Home/TablaPremios" class="btn-close" aria-label="Close"></a>
                </div>
                <form method="post" action="/Home/GuardarPremio">
                    <div class="modal-body">
                        <input type="hidden" name="Id" value="@premioActual.Id" />
                        <input type="hidden" name="FechaCreacion" value="@premioActual.FechaCreacion.ToString("yyyy-MM-ddTHH:mm:ss")" />
                        
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" name="Nombre" value="@premioActual.Nombre" required />
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="Descripcion" rows="3">@premioActual.Descripcion</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="costo" class="form-label">Costo</label>
                            <input type="number" step="0.01" class="form-control" id="costo" name="Costo" value="@premioActual.Costo" required min="0.01" />
                            <small class="text-muted">Formato: 1000000 (sin puntos ni comas)</small>
                        </div>
                        <div class="mb-3">
                            <label for="puntosRequeridos" class="form-label">Puntos Requeridos</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="puntosRequeridos" name="PuntosRequeridos" value="@premioActual.PuntosRequeridos" min="0" step="1" />
                                <button type="button" class="btn btn-outline-secondary" id="btnCalcularPuntos" onclick="calcularPuntos()" title="Recalcular puntos automáticamente">
                                    <i class="bi bi-calculator"></i> Calcular
                                </button>
                            </div>
                            <small class="text-muted">Se calcula automáticamente al cambiar el costo. Puede editar manualmente si lo desea.</small>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" name="Stock" value="@premioActual.Stock" required min="0" />
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="hidden" name="Activo" value="false" />
                                @if (premioActual.Activo)
                                {
                                    <input class="form-check-input" type="checkbox" id="activo" name="Activo" value="true" checked />
                                }
                                else
                                {
                                    <input class="form-check-input" type="checkbox" id="activo" name="Activo" value="true" />
                                }
                                <label class="form-check-label" for="activo">
                                    Activo
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="/Home/TablaPremios" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script>
    let edicionManual = false;

    function calcularPuntos() {
        const costoInput = document.getElementById('costo');
        const puntosInput = document.getElementById('puntosRequeridos');
        const costo = parseFloat(costoInput.value) || 0;
        
        if (costo > 0) {
            // Hacer una llamada AJAX para calcular los puntos
            fetch('/Home/CalcularPuntosRequeridos?costo=' + costo)
                .then(response => response.json())
                .then(data => {
                    if (data.puntosRequeridos) {
                        puntosInput.value = data.puntosRequeridos;
                        edicionManual = false;
                    } else {
                        puntosInput.value = 0;
                    }
                })
                .catch(error => {
                    console.error('Error al calcular puntos:', error);
                    puntosInput.value = 0;
                });
        } else {
            puntosInput.value = 0;
        }
    }

    // Detectar cuando el usuario edita manualmente el campo de puntos
    document.addEventListener('DOMContentLoaded', function() {
        const puntosInput = document.getElementById('puntosRequeridos');
        const costoInput = document.getElementById('costo');
        
        if (puntosInput) {
            puntosInput.addEventListener('input', function() {
                edicionManual = true;
            });
            
            puntosInput.addEventListener('focus', function() {
                edicionManual = true;
            });
        }
        
        if (costoInput) {
            // Remover el oninput del HTML y manejarlo aquí
            costoInput.addEventListener('input', function() {
                // Solo calcular automáticamente si no se está editando manualmente
                if (!edicionManual) {
                    calcularPuntos();
                }
            });
        }
    });

    // Manejar eliminación de premios con SweetAlert2
    document.querySelectorAll('.form-eliminar-premio').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const nombre = this.dataset.nombre || 'este premio';
            const result = await Swal.fire({
                title: '¿Está seguro?',
                text: `¿Desea eliminar el premio "${nombre}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });
            if (result.isConfirmed) {
                this.submit();
            }
        });
    });
</script>
