@using CalificacionXPuntosWeb.Models
@using CalificacionXPuntosWeb.Services
@{
    ViewData["Title"] = "Listado de Redimidos";
    var redenciones = ViewBag.Redenciones as List<Redencion> ?? new List<Redencion>();
    var totalRegistros = ViewBag.TotalRegistros ?? 0;
    var paginaActual = ViewBag.PaginaActual ?? 1;
    var totalPaginas = ViewBag.TotalPaginas ?? 1;
    var esSuperAdmin = ViewBag.EsSuperAdmin ?? false;
}

<h3>Listado de Redimidos</h3>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-header">
        <h5>Filtros</h5>
    </div>
    <div class="card-body">
        <form method="get" action="/Home/ListadoRedimidos">
            <div class="row g-2">
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Número Documento:</label>
                    <input type="text" class="form-control" name="filtroDocumento" value="@ViewBag.FiltroDocumento" />
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Nombre Usuario:</label>
                    <input type="text" class="form-control" name="filtroNombre" value="@ViewBag.FiltroNombre" />
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Premio:</label>
                    <input type="text" class="form-control" name="filtroPremio" value="@ViewBag.FiltroPremio" />
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Estado:</label>
                    <select class="form-select" name="filtroEstado">
                        <option value="">Todos</option>
                        <option value="Redimido" selected="@(ViewBag.FiltroEstado == "Redimido")">Redimido</option>
                        <option value="Cancelado" selected="@(ViewBag.FiltroEstado == "Cancelado")">Cancelado</option>
                    </select>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Fecha Desde:</label>
                    <input type="date" class="form-control" name="filtroFechaDesde" value="@ViewBag.FiltroFechaDesde" />
                </div>
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label">Fecha Hasta:</label>
                    <input type="date" class="form-control" name="filtroFechaHasta" value="@ViewBag.FiltroFechaHasta" />
                </div>
                <div class="col-12 col-md-12 col-lg-6">
                    <div class="d-flex flex-column flex-md-row gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                        <a href="/Home/ListadoRedimidos" class="btn btn-secondary">Limpiar Filtros</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tabla de resultados -->
<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Documento</th>
                <th>Nombre</th>
                <th>Premio</th>
                <th>Puntos Utilizados</th>
                <th>Fecha Redención</th>
                <th>Estado</th>
                @if (esSuperAdmin)
                {
                    <th><i class="bi bi-gear"></i></th>
                }
            </tr>
        </thead>
        <tbody>
            @if (redenciones.Any())
            {
                @foreach (var redencion in redenciones)
                {
                    <tr>
                        <td>@redencion.Id</td>
                        <td>@redencion.NumeroDocumento</td>
                        <td>@redencion.NombreUsuario</td>
                        <td>@redencion.NombrePremio</td>
                        <td>@redencion.PuntosUtilizados</td>
                        <td>@TimeHelper.ToColombiaTime(redencion.FechaRedencion).ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@redencion.Estado</td>
                        @if (esSuperAdmin)
                        {
                            <td>
                                <form method="post" action="/Home/EliminarRedencion" style="display:inline;" class="form-eliminar-redencion" data-id="@redencion.Id" data-nombre="@redencion.NombrePremio" data-documento="@redencion.NumeroDocumento">
                                    <input type="hidden" name="id" value="@redencion.Id" />
                                    <input type="hidden" name="numeroDocumento" value="@redencion.NumeroDocumento" />
                                    <button type="submit" class="btn btn-sm btn-danger p-1" style="margin-left: 0.25rem;" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        }
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="@(esSuperAdmin ? 8 : 7)" class="text-center">No se encontraron registros</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Paginación -->
@if (totalPaginas > 1)
{
    <nav aria-label="Paginación">
        <ul class="pagination justify-content-center">
            <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                @if (paginaActual > 1)
                {
                    <a class="page-link" href="/Home/ListadoRedimidos?filtroDocumento=@ViewBag.FiltroDocumento&filtroNombre=@ViewBag.FiltroNombre&filtroPremio=@ViewBag.FiltroPremio&filtroEstado=@ViewBag.FiltroEstado&filtroFechaDesde=@ViewBag.FiltroFechaDesde&filtroFechaHasta=@ViewBag.FiltroFechaHasta&pagina=@(paginaActual - 1)">Anterior</a>
                }
                else
                {
                    <span class="page-link">Anterior</span>
                }
            </li>
            @for (int i = 1; i <= totalPaginas; i++)
            {
                <li class="page-item @(i == paginaActual ? "active" : "")">
                    <a class="page-link" href="/Home/ListadoRedimidos?filtroDocumento=@ViewBag.FiltroDocumento&filtroNombre=@ViewBag.FiltroNombre&filtroPremio=@ViewBag.FiltroPremio&filtroEstado=@ViewBag.FiltroEstado&filtroFechaDesde=@ViewBag.FiltroFechaDesde&filtroFechaHasta=@ViewBag.FiltroFechaHasta&pagina=@i">@i</a>
                </li>
            }
            <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                @if (paginaActual < totalPaginas)
                {
                    <a class="page-link" href="/Home/ListadoRedimidos?filtroDocumento=@ViewBag.FiltroDocumento&filtroNombre=@ViewBag.FiltroNombre&filtroPremio=@ViewBag.FiltroPremio&filtroEstado=@ViewBag.FiltroEstado&filtroFechaDesde=@ViewBag.FiltroFechaDesde&filtroFechaHasta=@ViewBag.FiltroFechaHasta&pagina=@(paginaActual + 1)">Siguiente</a>
                }
                else
                {
                    <span class="page-link">Siguiente</span>
                }
            </li>
        </ul>
    </nav>
}

<div class="mt-3">
    <strong>Total de registros: @totalRegistros</strong>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.form-eliminar-redencion').forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const id = this.dataset.id;
                const nombre = this.dataset.nombre;
                const documento = this.dataset.documento;
                const action = this.action;

                Swal.fire({
                    title: '¿Está seguro?',
                    text: `¿Desea eliminar la redención del premio '${nombre}' para el documento ${documento}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.submit();
                    }
                });
            });
        });
    </script>
}

