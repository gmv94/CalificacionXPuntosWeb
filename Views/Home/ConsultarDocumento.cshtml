@using CalificacionXPuntosWeb.Services
@{
    ViewData["Title"] = "Consultar por Documento";
    var puntosUsuario = ViewBag.PuntosUsuario as CalificacionXPuntosWeb.Models.PuntosAcumulados;
    var redencionesUsuario = ViewBag.RedencionesUsuario as List<CalificacionXPuntosWeb.Models.Redencion>;
    var puntosHistoricosUsuario = ViewBag.PuntosHistoricosUsuario as List<CalificacionXPuntosWeb.Models.PuntosHistoricos>;
    var puntosDisponibles = ViewBag.PuntosDisponibles as int? ?? 0;
    var puntosUtilizados = ViewBag.PuntosUtilizados as int? ?? 0;
    var numeroDocumento = ViewBag.NumeroDocumento as string ?? "";
}

<h3>Consultar por Número de Documento</h3>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Buscar Usuario</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/Home/ConsultarDocumento">
                    <div class="mb-3">
                        <label for="numeroDocumento" class="form-label">Número de Documento</label>
                        <input type="text" class="form-control" id="numeroDocumento" name="numeroDocumento" value="@numeroDocumento" onkeypress="if(event.key === 'Enter') { this.form.submit(); }" />
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@if (puntosUsuario != null)
{
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5>Información del Usuario</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-3 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Documento:</strong><br />
                                <span>@puntosUsuario.NumeroDocumento</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-3 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Nombre:</strong><br />
                                <span>@puntosUsuario.NombreUsuario</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-2 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Total Ideas:</strong><br />
                                <span>@puntosUsuario.TotalIdeas</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-2 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Puntos Históricos:</strong><br />
                                <span>@puntosUsuario.PuntosHistoricos</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-2 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Total Puntos:</strong><br />
                                <span class="badge bg-success fs-6">@puntosUsuario.TotalPuntos</span>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2 mt-md-3">
                        <div class="col-12 col-md-3 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Puntos Disponibles:</strong><br />
                                <span class="badge bg-info fs-6">@puntosDisponibles</span>
                            </div>
                        </div>
                        <div class="col-12 col-md-3 mb-2 mb-md-0">
                            <div class="info-item">
                                <strong>Puntos Utilizados:</strong><br />
                                <span class="badge bg-warning fs-6">@puntosUtilizados</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Ideas Registradas</h5>
                </div>
                <div class="card-body">
                    @if (puntosUsuario.Ideas == null || !puntosUsuario.Ideas.Any())
                    {
                        <p>No hay ideas registradas.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Radicado</th>
                                        <th>Fecha Radicado</th>
                                        <th>Título de la Idea</th>
                                        <th>Estado</th>
                                        <th>Puntos</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var idea in puntosUsuario.Ideas)
                                    {
                                        var observacionesId = $"obs_{idea.Id}";
                                        <tr>
                                            <td>@idea.Radicado</td>
                                            <td>@(idea.FechaRadicado != default(DateTime) ? idea.FechaRadicado.ToString("dd/MM/yyyy") : "-")</td>
                                            <td>@(idea.TituloIdea ?? "-")</td>
                                            <td>@idea.Estado</td>
                                            <td>@idea.Puntos</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(idea.Observaciones))
                                                {
                                                    <button class="btn btn-sm btn-link p-0 observaciones-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#@observacionesId" aria-expanded="false" aria-controls="@observacionesId">
                                                        <i class="bi bi-chevron-down toggle-icon"></i> <span class="toggle-text">Ver</span>
                                                    </button>
                                                    <div class="collapse" id="@observacionesId">
                                                        <div class="mt-2 p-2 bg-light border rounded">
                                                            @idea.Observaciones
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (puntosHistoricosUsuario != null && puntosHistoricosUsuario.Any())
    {
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Puntos Históricos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Puntos</th>
                                        <th>Observaciones</th>
                                        <th>Fecha Asignación</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var historico in puntosHistoricosUsuario)
                                    {
                                        <tr>
                                            <td>@historico.Puntos</td>
                                            <td>@historico.Observaciones</td>
                                            <td>@TimeHelper.ToColombiaTime(historico.FechaRegistro).ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Premios Redimidos</h5>
                </div>
                <div class="card-body">
                    @if (redencionesUsuario == null || !redencionesUsuario.Any())
                    {
                        <p>No hay premios redimidos.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Premio</th>
                                        <th>Puntos Utilizados</th>
                                        <th>Fecha Redención</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var redencion in redencionesUsuario)
                                    {
                                        <tr>
                                            <td>@redencion.NombrePremio</td>
                                            <td>@redencion.PuntosUtilizados</td>
                                            <td>@TimeHelper.ToColombiaTime(redencion.FechaRedencion).ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@redencion.Estado</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(ViewBag.Mensaje as string))
{
    <div class="alert alert-@(ViewBag.EsExito == true ? "success" : "danger") alert-dismissible fade show mt-3" role="alert">
        @ViewBag.Mensaje
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@section Scripts {
    <script>
        // Inicializar collapse de observaciones
        document.addEventListener('DOMContentLoaded', function() {
            // Asegurar que todos los collapse estén ocultos por defecto
            document.querySelectorAll('.collapse[id^="obs_"]').forEach(function(collapse) {
                collapse.classList.remove('show');
            });

            // Agregar event listeners para cambiar el ícono y texto
            document.querySelectorAll('[data-bs-toggle="collapse"][data-bs-target^="#obs_"]').forEach(function(button) {
                const targetId = button.getAttribute('data-bs-target');
                const collapseElement = document.querySelector(targetId);
                
                if (collapseElement) {
                    collapseElement.addEventListener('show.bs.collapse', function() {
                        const icon = button.querySelector('.toggle-icon');
                        const text = button.querySelector('.toggle-text');
                        if (icon) {
                            icon.classList.remove('bi-chevron-down');
                            icon.classList.add('bi-chevron-up');
                        }
                        if (text) {
                            text.textContent = 'Ocultar';
                        }
                        button.setAttribute('aria-expanded', 'true');
                    });

                    collapseElement.addEventListener('hide.bs.collapse', function() {
                        const icon = button.querySelector('.toggle-icon');
                        const text = button.querySelector('.toggle-text');
                        if (icon) {
                            icon.classList.remove('bi-chevron-up');
                            icon.classList.add('bi-chevron-down');
                        }
                        if (text) {
                            text.textContent = 'Ver';
                        }
                        button.setAttribute('aria-expanded', 'false');
                    });
                }
            });
        });
    </script>
}


