@page "/registro"
@using CalificacionXPuntosWeb.Models
@using CalificacionXPuntosWeb.Services
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Registrar Usuario</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow">
                <div class="card-header bg-success text-white text-center">
                    <h4>Registrar Nuevo Usuario</h4>
                </div>
                <div class="card-body">
                    <EditForm Model="@nuevoUsuario" OnValidSubmit="OnRegistrar">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label for="nombreUsuario" class="form-label">Usuario:</label>
                            <InputText id="nombreUsuario" class="form-control" @bind-Value="nuevoUsuario.NombreUsuario" />
                            <ValidationMessage For="@(() => nuevoUsuario.NombreUsuario)" />
                        </div>
                        <div class="mb-3">
                            <label for="contrasena" class="form-label">Contraseña:</label>
                            <InputText id="contrasena" type="password" class="form-control" @bind-Value="contrasena" />
                            <ValidationMessage For="@(() => contrasena)" />
                        </div>
                        <div class="mb-3">
                            <label for="confirmarContrasena" class="form-label">Confirmar Contraseña:</label>
                            <InputText id="confirmarContrasena" type="password" class="form-control" @bind-Value="confirmarContrasena" />
                        </div>
                        <div class="mb-3">
                            <label for="rol" class="form-label">Rol:</label>
                            <InputSelect id="rol" class="form-select" @bind-Value="nuevoUsuario.Rol">
                                <option value="Usuario">Usuario (Consulta)</option>
                                <option value="SuperAdmin">SuperAdmin</option>
                            </InputSelect>
                        </div>
                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="alert alert-danger">@mensajeError</div>
                        }
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">Registrar</button>
                            <button type="button" class="btn btn-secondary mt-2" @onclick="Cancelar">Cancelar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private Usuario nuevoUsuario = new() { Rol = "Usuario" };
    private string contrasena = string.Empty;
    private string confirmarContrasena = string.Empty;
    private string mensajeError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Verificar si el usuario actual es SuperAdmin
        var usuarioId = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "usuarioId");
        if (string.IsNullOrEmpty(usuarioId))
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var usuario = AuthService.GetUsuarioById(int.Parse(usuarioId));
        if (usuario == null || usuario.Rol != "SuperAdmin")
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Acceso Denegado",
                text = "Solo los SuperAdmin pueden registrar usuarios.",
                confirmButtonText = "Aceptar"
            });
            NavigationManager.NavigateTo("/");
            return;
        }
    }

    private async Task OnRegistrar()
    {
        mensajeError = string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoUsuario.NombreUsuario))
        {
            mensajeError = "El usuario es requerido.";
            return;
        }

        if (string.IsNullOrWhiteSpace(contrasena))
        {
            mensajeError = "La contraseña es requerida.";
            return;
        }

        if (contrasena != confirmarContrasena)
        {
            mensajeError = "Las contraseñas no coinciden.";
            return;
        }

        if (contrasena.Length < 4)
        {
            mensajeError = "La contraseña debe tener al menos 4 caracteres.";
            return;
        }

        var resultado = AuthService.RegistrarUsuario(nuevoUsuario, contrasena);
        if (resultado)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "success",
                title = "¡Éxito!",
                text = "Usuario registrado exitosamente.",
                confirmButtonText = "Aceptar"
            });
            NavigationManager.NavigateTo("/");
        }
        else
        {
            mensajeError = "El usuario ya existe o hubo un error al registrar.";
        }
    }

    private void Cancelar()
    {
        NavigationManager.NavigateTo("/");
    }
}

