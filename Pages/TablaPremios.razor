@page "/tabla-premios"
@inherits AuthComponentBase
@using CalificacionXPuntosWeb.Models
@using CalificacionXPuntosWeb.Services
@inject PremioService PremioService
@inject ValorPuntosService ValorPuntosService
@inject LogService LogService

<PageTitle>Tabla de Premios</PageTitle>

<h3>Tabla de Premios</h3>

@if (esSuperAdmin)
{
    <div class="mb-3">
        <button class="btn btn-primary" @onclick="NuevoPremio">Nuevo Premio</button>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Costo</th>
                <th>Puntos Requeridos</th>
                <th>Stock</th>
                <th>Activo</th>
                <th>Fecha Creación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var premio in premios)
            {
                <tr>
                    <td>@premio.Id</td>
                    <td>@premio.Nombre</td>
                    <td>@premio.Descripcion</td>
                    <td>$@premio.Costo.ToString("N0")</td>
                    <td>@premio.PuntosRequeridos</td>
                    <td>@premio.Stock</td>
                    <td>
                        @if (premio.Activo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td>@premio.FechaCreacion.ToString("dd/MM/yyyy")</td>
                    <td>
                        @if (esSuperAdmin)
                        {
                            <button class="btn btn-sm btn-warning" @onclick="() => EditarPremio(premio.Id)">
                                Editar
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="() => EliminarPremio(premio.Id)">
                                Eliminar
                            </button>
                        }
                        else
                        {
                            <span class="text-muted">Solo consulta</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (mostrarModal)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(premioActual.Id == 0 ? "Nuevo Premio" : "Editar Premio")</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" @bind="premioActual.Nombre" />
                    </div>
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion" @bind="premioActual.Descripcion" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="costo" class="form-label">Costo</label>
                        <input type="text" id="costo" class="form-control" value="@costoFormateado" @oninput="OnCostoInput" />
                        <small class="text-muted">Formato: 1.000.000</small>
                    </div>
                    <div class="mb-3">
                        <label for="puntosRequeridos" class="form-label">Puntos Requeridos</label>
                        <input type="number" class="form-control" id="puntosRequeridos" @bind="premioActual.PuntosRequeridos" readonly />
                        <small class="text-muted">Calculado automáticamente según el costo y el valor por punto configurado.</small>
                        @if (premioActual.Costo > 0 && premioActual.PuntosRequeridos == 0)
                        {
                            <small class="text-warning d-block mt-1">
                                ⚠️ No se encontró un valor por punto configurado para este rango de costo. Configure un valor por punto en Administración > Valor Puntos.
                            </small>
                        }
                    </div>
                    <div class="mb-3">
                        <label for="stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="stock" @bind="premioActual.Stock" />
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="activo" @bind="premioActual.Activo" />
                            <label class="form-check-label" for="activo">
                                Activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="GuardarPremio">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-@(esExito ? "success" : "danger") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
    </div>
}

@code {
    private List<Premio> premios = new List<Premio>();
    private bool mostrarModal = false;
    private Premio premioActual = new Premio();
    private string mensaje = string.Empty;
    private bool esExito = false;
    private string costoFormateado = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await RequiereAutenticacion();
        await VerificarAutenticacion(); // Asegurar que esSuperAdmin esté actualizado
        CargarPremios();
    }

    private void CargarPremios()
    {
        premios = PremioService.GetAllPremios();
    }

    private void NuevoPremio()
    {
        premioActual = new Premio
        {
            Id = 0,
            Nombre = string.Empty,
            Descripcion = string.Empty,
            Costo = 0,
            PuntosRequeridos = 0,
            Stock = 0,
            Activo = true,
            FechaCreacion = TimeHelper.GetColombiaTime()
        };
        costoFormateado = string.Empty;
        mostrarModal = true;
    }

    private void EditarPremio(int id)
    {
        var premio = PremioService.GetPremioById(id);
        if (premio != null)
        {
            premioActual = new Premio
            {
                Id = premio.Id,
                Nombre = premio.Nombre,
                Descripcion = premio.Descripcion,
                Costo = premio.Costo,
                PuntosRequeridos = premio.PuntosRequeridos,
                Stock = premio.Stock,
                Activo = premio.Activo,
                FechaCreacion = premio.FechaCreacion
            };
            costoFormateado = premio.Costo.ToString("N0");
            CalcularPuntosRequeridos();
            mostrarModal = true;
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        premioActual = new Premio
        {
            Id = 0,
            Nombre = string.Empty,
            Descripcion = string.Empty,
            Costo = 0,
            PuntosRequeridos = 0,
            Stock = 0,
            Activo = true,
            FechaCreacion = TimeHelper.GetColombiaTime()
        };
        costoFormateado = string.Empty;
    }

    private void OnCostoInput(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString() ?? string.Empty;
        // Remover caracteres no numéricos excepto puntos
        var soloNumeros = new string(valor.Where(c => char.IsDigit(c) || c == '.').ToArray());
        
        if (decimal.TryParse(soloNumeros.Replace(".", ""), out var costo))
        {
            premioActual.Costo = costo;
            costoFormateado = costo.ToString("N0");
            CalcularPuntosRequeridos();
            StateHasChanged(); // Forzar actualización inmediata
        }
        else if (string.IsNullOrEmpty(soloNumeros))
        {
            premioActual.Costo = 0;
            costoFormateado = string.Empty;
            CalcularPuntosRequeridos();
            StateHasChanged(); // Forzar actualización inmediata
        }
        else
        {
            // Mantener el formato visual pero actualizar el valor
            costoFormateado = soloNumeros;
        }
    }

    private void CalcularPuntosRequeridos()
    {
        if (premioActual.Costo <= 0)
        {
            premioActual.PuntosRequeridos = 0;
            StateHasChanged();
            return;
        }

        try
        {
            var valorPuntos = ValorPuntosService.GetValorPuntosPorCosto(premioActual.Costo);
            if (valorPuntos != null && valorPuntos.ValorPorPunto > 0)
            {
                premioActual.PuntosRequeridos = (int)Math.Ceiling(premioActual.Costo / valorPuntos.ValorPorPunto);
            }
            else
            {
                premioActual.PuntosRequeridos = 0;
            }
        }
        catch (Exception ex)
        {
            // En caso de error, establecer a 0
            premioActual.PuntosRequeridos = 0;
            Console.WriteLine($"Error al calcular puntos requeridos: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task GuardarPremio()
    {
        if (string.IsNullOrWhiteSpace(premioActual.Nombre))
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = "El nombre es requerido.",
                confirmButtonText = "Aceptar"
            });
            return;
        }

        if (premioActual.Costo <= 0)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = "El costo debe ser mayor a 0.",
                confirmButtonText = "Aceptar"
            });
            return;
        }

        // Recalcular puntos antes de guardar
        CalcularPuntosRequeridos();

        if (premioActual.PuntosRequeridos <= 0)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = "No se encontró un valor por punto configurado para este rango de costo. Configure un valor por punto en Administración > Valor Puntos.",
                confirmButtonText = "Aceptar"
            });
            return;
        }

        try
        {
            if (premioActual.Id == 0)
            {
                // Asegurar que FechaCreacion tenga un valor antes de guardar
                if (premioActual.FechaCreacion == default(DateTime))
                {
                    premioActual.FechaCreacion = TimeHelper.GetColombiaTime();
                }
                
                // Asegurar que Descripcion no sea null
                if (premioActual.Descripcion == null)
                {
                    premioActual.Descripcion = string.Empty;
                }
                
                PremioService.AddPremio(premioActual);
                
                LogService.RegistrarLog("Create", "Premio", premioActual.Id, nombreUsuario ?? "Sistema", 
                    $"Premio creado - Nombre: {premioActual.Nombre}, Costo: ${premioActual.Costo:N0}");
                await JSRuntime.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "success",
                    title = "¡Éxito!",
                    text = "Premio creado exitosamente.",
                    confirmButtonText = "Aceptar"
                });
            }
            else
            {
                PremioService.UpdatePremio(premioActual);
                LogService.RegistrarLog("Update", "Premio", premioActual.Id, nombreUsuario ?? "Sistema", 
                    $"Premio actualizado - Nombre: {premioActual.Nombre}, Costo: ${premioActual.Costo:N0}");
                await JSRuntime.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "success",
                    title = "¡Éxito!",
                    text = "Premio actualizado exitosamente.",
                    confirmButtonText = "Aceptar"
                });
            }
            CargarPremios();
            CerrarModal();
        }
        catch (Exception ex)
        {
            var errorMessage = ex.Message;
            var innerEx = ex.InnerException;
            while (innerEx != null)
            {
                errorMessage += $" | Inner: {innerEx.Message}";
                innerEx = innerEx.InnerException;
            }
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = $"Error al guardar: {errorMessage}",
                confirmButtonText = "Aceptar",
                width = "600px"
            });
        }
    }

    private async Task EliminarPremio(int id)
    {
        var confirmado = await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este premio?");
        if (confirmado)
        {
            try
            {
                var premio = PremioService.GetPremioById(id);
                PremioService.DeletePremio(id);
                LogService.RegistrarLog("Delete", "Premio", id, nombreUsuario ?? "Sistema", 
                    $"Premio eliminado - Nombre: {premio?.Nombre ?? "N/A"}");
                await JSRuntime.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "success",
                    title = "¡Éxito!",
                    text = "Premio eliminado exitosamente.",
                    confirmButtonText = "Aceptar"
                });
                CargarPremios();
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("Swal.fire", new
                {
                    icon = "error",
                    title = "Error",
                    text = $"Error al eliminar: {ex.Message}",
                    confirmButtonText = "Aceptar"
                });
            }
        }
    }
}

