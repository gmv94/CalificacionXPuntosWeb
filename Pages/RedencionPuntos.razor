@page "/redencion-puntos"
@inherits AuthComponentBase
@using CalificacionXPuntosWeb.Models
@using CalificacionXPuntosWeb.Services
@inject IdeaService IdeaService
@inject PremioService PremioService
@inject RedencionService RedencionService
@inject PuntosHistoricosService PuntosHistoricosService
@inject LogService LogService

<PageTitle>Redención de Puntos</PageTitle>

<h3>Redención de Puntos</h3>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Buscar Usuario</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="numeroDocumento" class="form-label">Número de Documento</label>
                    <input type="text" class="form-control" id="numeroDocumento" @bind="numeroDocumentoBuscar" @onkeypress="HandleKeyPress" />
                </div>
                <button class="btn btn-primary" @onclick="BuscarUsuario">Buscar</button>
            </div>
        </div>
    </div>
</div>

@if (puntosUsuario != null)
{
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Información del Usuario</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Documento:</strong> @puntosUsuario.NumeroDocumento
                        </div>
                        <div class="col-md-3">
                            <strong>Nombre:</strong> @puntosUsuario.NombreUsuario
                        </div>
                        <div class="col-md-2">
                            <strong>Puntos Históricos:</strong> @puntosUsuario.PuntosHistoricos
                        </div>
                        <div class="col-md-2">
                            <strong>Total Puntos:</strong> @puntosUsuario.TotalPuntos
                        </div>
                        <div class="col-md-2">
                            <strong>Puntos Disponibles:</strong> 
                            <span class="badge bg-success">@puntosDisponibles</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Redimir Premio</h5>
                </div>
                <div class="card-body">
                    @if (premiosDisponibles == null || !premiosDisponibles.Any())
                    {
                        <p>No hay premios disponibles.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th>Puntos Requeridos</th>
                                        <th>Stock</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var premio in premiosDisponibles)
                                    {
                                        <tr>
                                            <td>@premio.Nombre</td>
                                            <td>@premio.Descripcion</td>
                                            <td>@premio.PuntosRequeridos</td>
                                            <td>@premio.Stock</td>
                                            <td>
                                                @if (puntosDisponibles >= premio.PuntosRequeridos)
                                                {
                                                    <button class="btn btn-sm btn-success" @onclick="() => RedimirPremio(premio.Id)">
                                                        Redimir
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-danger">Puntos insuficientes</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Premios Redimidos</h5>
                </div>
                <div class="card-body">
                    @if (redencionesUsuario == null || !redencionesUsuario.Any())
                    {
                        <p>No hay premios redimidos.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Premio</th>
                                        <th>Puntos Utilizados</th>
                                        <th>Fecha Redención</th>
                                        <th>Estado</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var redencion in redencionesUsuario)
                                    {
                                        <tr>
                                            <td>@redencion.NombrePremio</td>
                                            <td>@redencion.PuntosUtilizados</td>
                                            <td>@redencion.FechaRedencion.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@redencion.Estado</td>
                                            <td>
                                                @if (esSuperAdmin)
                                                {
                                                    <button class="btn btn-sm btn-danger" @onclick="() => EliminarRedencion(redencion.Id)">
                                                        Eliminar
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-@(esExito ? "success" : "danger") alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = string.Empty"></button>
    </div>
}


@code {
    private string numeroDocumentoBuscar = string.Empty;
    private Models.PuntosAcumulados? puntosUsuario;
    private List<Premio>? premiosDisponibles;
    private List<Redencion>? redencionesUsuario;
    private int puntosDisponibles = 0;
    private string mensaje = string.Empty;
    private bool esExito = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await RequiereAutenticacion();
        await VerificarAutenticacion(); // Asegurar que esSuperAdmin esté actualizado
        CargarPremios();
    }

    private void CargarPremios()
    {
        premiosDisponibles = PremioService.GetPremiosDisponibles();
    }

    private void BuscarUsuario()
    {
        if (string.IsNullOrWhiteSpace(numeroDocumentoBuscar))
        {
            mensaje = "Por favor ingrese un número de documento.";
            esExito = false;
            return;
        }

        puntosUsuario = IdeaService.GetPuntosAcumuladosPorDocumento(numeroDocumentoBuscar);
        
        if (puntosUsuario == null)
        {
            mensaje = "No se encontraron puntos para este documento.";
            esExito = false;
            puntosUsuario = null;
            redencionesUsuario = null;
            return;
        }

        // Calcular puntos disponibles
        redencionesUsuario = RedencionService.GetRedencionesPorDocumento(numeroDocumentoBuscar);
        var puntosUtilizados = redencionesUsuario.Sum(r => r.PuntosUtilizados);
        puntosDisponibles = puntosUsuario.TotalPuntos - puntosUtilizados;

        mensaje = string.Empty;
    }

    private async Task RedimirPremio(int premioId)
    {
        var resultado = RedencionService.RedimirPremio(numeroDocumentoBuscar, premioId);
        mensaje = resultado.Message;
        esExito = resultado.Success;

        if (resultado.Success)
        {
            // Recargar datos
            BuscarUsuario();
            CargarPremios();
        }

        await Task.CompletedTask;
    }

    private async Task EliminarRedencion(int id)
    {
        var redencion = RedencionService.GetRedencionById(id);
        RedencionService.DeleteRedencion(id);
        LogService.RegistrarLog("Delete", "Redencion", id, nombreUsuario ?? "Sistema", 
            $"Redención eliminada - Premio: {redencion?.NombrePremio ?? "N/A"}, Documento: {redencion?.NumeroDocumento ?? "N/A"}");
        mensaje = "Redención eliminada exitosamente.";
        esExito = true;
        
        // Recargar datos
        BuscarUsuario();
        CargarPremios();
        
        await Task.CompletedTask;
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            BuscarUsuario();
        }
    }

}

