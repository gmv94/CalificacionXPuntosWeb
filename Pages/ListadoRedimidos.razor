@page "/listado-redimidos"
@inherits AuthComponentBase
@using CalificacionXPuntosWeb.Models
@using CalificacionXPuntosWeb.Services
@inject RedencionService RedencionService
@inject LogService LogService

<PageTitle>Listado de Redimidos</PageTitle>

<h3>Listado de Redimidos</h3>

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-header">
        <h5>Filtros</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Número Documento:</label>
                <input type="text" class="form-control" value="@filtroDocumento" @oninput="(e) => { filtroDocumento = e.Value?.ToString() ?? string.Empty; paginaActual = 1; AplicarFiltros(); }" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Nombre Usuario:</label>
                <input type="text" class="form-control" value="@filtroNombre" @oninput="(e) => { filtroNombre = e.Value?.ToString() ?? string.Empty; paginaActual = 1; AplicarFiltros(); }" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Premio:</label>
                <input type="text" class="form-control" value="@filtroPremio" @oninput="(e) => { filtroPremio = e.Value?.ToString() ?? string.Empty; paginaActual = 1; AplicarFiltros(); }" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Estado:</label>
                <select class="form-select" value="@filtroEstado" @onchange="(e) => { filtroEstado = e.Value?.ToString() ?? string.Empty; paginaActual = 1; AplicarFiltros(); }">
                    <option value="">Todos</option>
                    <option value="Redimido">Redimido</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <label class="form-label">Fecha Desde:</label>
                <input type="date" class="form-control" value="@filtroFechaDesde?.ToString("yyyy-MM-dd")" @onchange="(e) => { if (DateTime.TryParse(e.Value?.ToString(), out var fecha)) { filtroFechaDesde = fecha; } else { filtroFechaDesde = null; } paginaActual = 1; AplicarFiltros(); }" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Fecha Hasta:</label>
                <input type="date" class="form-control" value="@filtroFechaHasta?.ToString("yyyy-MM-dd")" @onchange="(e) => { if (DateTime.TryParse(e.Value?.ToString(), out var fecha)) { filtroFechaHasta = fecha; } else { filtroFechaHasta = null; } paginaActual = 1; AplicarFiltros(); }" />
            </div>
            <div class="col-md-6">
                <button class="btn btn-secondary mt-4" @onclick="LimpiarFiltros">Limpiar Filtros</button>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de resultados -->
<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Documento</th>
                <th>Nombre</th>
                <th>Premio</th>
                <th>Puntos Utilizados</th>
                <th>Fecha Redención</th>
                <th>Estado</th>
                @if (esSuperAdmin)
                {
                    <th><i class="bi bi-gear"></i></th>
                }
            </tr>
        </thead>
        <tbody>
            @if (redencionesPaginadas.Any())
            {
                @foreach (var redencion in redencionesPaginadas)
                {
                    <tr>
                        <td>@redencion.Id</td>
                        <td>@redencion.NumeroDocumento</td>
                        <td>@redencion.NombreUsuario</td>
                        <td>@redencion.NombrePremio</td>
                        <td>@redencion.PuntosUtilizados</td>
                        <td>@TimeHelper.ToColombiaTime(redencion.FechaRedencion).ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@redencion.Estado</td>
                        @if (esSuperAdmin)
                        {
                            <td>
                                <button class="btn btn-sm btn-danger p-1" style="margin-left: 0.25rem;" @onclick="() => EliminarRedencion(redencion)" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        }
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="@(esSuperAdmin ? 8 : 7)" class="text-center">No se encontraron registros</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Paginación -->
@if (totalPaginas > 1)
{
    <nav aria-label="Paginación">
        <ul class="pagination justify-content-center">
            <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)" disabled="@(paginaActual == 1)">Anterior</button>
            </li>
            @for (int i = 1; i <= totalPaginas; i++)
            {
                <li class="page-item @(i == paginaActual ? "active" : "")">
                    <button class="page-link" @onclick="() => CambiarPagina(i)">@i</button>
                </li>
            }
            <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)" disabled="@(paginaActual == totalPaginas)">Siguiente</button>
            </li>
        </ul>
    </nav>
}

<div class="mt-3">
    <strong>Total de registros: @redencionesFiltradas.Count</strong>
</div>

@code {
    private List<Redencion> todasLasRedenciones = new();
    private List<Redencion> redencionesFiltradas = new();
    private List<Redencion> redencionesPaginadas = new();
    
    private string filtroDocumento = string.Empty;
    private string filtroNombre = string.Empty;
    private string filtroPremio = string.Empty;
    private string filtroEstado = string.Empty;
    private DateTime? filtroFechaDesde = null;
    private DateTime? filtroFechaHasta = null;
    
    private int paginaActual = 1;
    private int registrosPorPagina = 20;
    private int totalPaginas = 1;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await RequiereAutenticacion();
        await VerificarAutenticacion();
        var rol = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "rol") ?? string.Empty;
        if (!esSuperAdmin && rol != "Consulta" && rol != "Usuario")
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Acceso Denegado",
                text = "Solo los SuperAdmin y usuarios con rol Consulta o Usuario pueden acceder a esta sección.",
                confirmButtonText = "Aceptar"
            });
            NavigationManager.NavigateTo("/");
            return;
        }
        CargarDatos();
    }

    private void CargarDatos()
    {
        try
        {
            todasLasRedenciones = RedencionService.GetAllRedenciones() ?? new List<Redencion>();
            AplicarFiltros();
        }
        catch
        {
            todasLasRedenciones = new List<Redencion>();
            redencionesFiltradas = new List<Redencion>();
            redencionesPaginadas = new List<Redencion>();
        }
    }

    private void AplicarFiltros()
    {
        var query = todasLasRedenciones.AsQueryable();

        if (!string.IsNullOrWhiteSpace(filtroDocumento))
        {
            query = query.Where(r => r.NumeroDocumento.Contains(filtroDocumento, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(filtroNombre))
        {
            query = query.Where(r => r.NombreUsuario.Contains(filtroNombre, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(filtroPremio))
        {
            query = query.Where(r => r.NombrePremio.Contains(filtroPremio, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrWhiteSpace(filtroEstado))
        {
            query = query.Where(r => r.Estado == filtroEstado);
        }

        if (filtroFechaDesde.HasValue)
        {
            query = query.Where(r => r.FechaRedencion.Date >= filtroFechaDesde.Value.Date);
        }

        if (filtroFechaHasta.HasValue)
        {
            query = query.Where(r => r.FechaRedencion.Date <= filtroFechaHasta.Value.Date);
        }

        // Ordenar por fecha más reciente primero y convertir a lista
        redencionesFiltradas = query.OrderByDescending(r => r.FechaRedencion).ToList();

        totalPaginas = (int)Math.Ceiling((double)redencionesFiltradas.Count / registrosPorPagina);
        if (totalPaginas < 1) totalPaginas = 1;
        if (paginaActual > totalPaginas) paginaActual = totalPaginas;

        ActualizarPaginacion();
    }

    private void ActualizarPaginacion()
    {
        var inicio = (paginaActual - 1) * registrosPorPagina;
        redencionesPaginadas = redencionesFiltradas.Skip(inicio).Take(registrosPorPagina).ToList();
    }

    private void CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            paginaActual = nuevaPagina;
            ActualizarPaginacion();
        }
    }

    private void LimpiarFiltros()
    {
        filtroDocumento = string.Empty;
        filtroNombre = string.Empty;
        filtroPremio = string.Empty;
        filtroEstado = string.Empty;
        filtroFechaDesde = null;
        filtroFechaHasta = null;
        paginaActual = 1;
        AplicarFiltros();
    }

    private async Task EliminarRedencion(Redencion redencion)
    {
        var confirmado = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Está seguro de eliminar la redención del premio '{redencion.NombrePremio}' para el documento {redencion.NumeroDocumento}?");
        if (!confirmado) return;

        try
        {
            RedencionService.DeleteRedencion(redencion.Id);
            LogService.RegistrarLog("Delete", "Redencion", redencion.Id, nombreUsuario ?? "Sistema", 
                $"Redención eliminada - Premio: {redencion.NombrePremio}, Documento: {redencion.NumeroDocumento}");
            
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "success",
                title = "Éxito",
                text = "Redención eliminada exitosamente.",
                confirmButtonText = "Aceptar"
            });
            
            CargarDatos();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", new
            {
                icon = "error",
                title = "Error",
                text = $"Error al eliminar la redención: {ex.Message}",
                confirmButtonText = "Aceptar"
            });
        }
    }
}

